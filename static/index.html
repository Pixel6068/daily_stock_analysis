<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥è‚¡ç¥¨åˆ†ææ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 800px; }
        .card { border: none; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .card-header { background-color: #fff; border-bottom: 1px solid #f0f0f0; border-radius: 12px 12px 0 0 !important; font-weight: bold; }
        .btn-primary { background-color: #007bff; border: none; border-radius: 8px; padding: 10px 20px; }
        .btn-primary:hover { background-color: #0056b3; }
        .report-content { white-space: pre-wrap; background: #fdfdfd; padding: 20px; border-radius: 8px; border: 1px solid #eee; max-height: 600px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
        .stock-tag { display: inline-block; padding: 2px 8px; background: #e7f3ff; color: #007bff; border-radius: 4px; font-size: 12px; margin-right: 5px; }
        .time-tag { color: #999; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-5">ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†ææ§åˆ¶å°</h2>
        
        <div class="card">
            <div class="card-header">ğŸš€ è§¦å‘åˆ†æ</div>
            <div class="card-body">
                <p class="text-muted small">ç³»ç»Ÿå°†åŒæ—¶åˆ†æï¼š<span class="stock-tag">NVDA</span> <span class="stock-tag">GOOGL</span> <span class="stock-tag">AMZN</span></p>
                <button id="analyzeBtn" class="btn btn-primary w-100">ç«‹å³å¼€å§‹æ™ºèƒ½åˆ†æ</button>
                <div id="analyzeStatus" class="mt-3"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“‚ å†å²åˆ†ææŠ¥å‘Š</div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="historyList">
                    <div class="p-4 text-center text-muted">æ­£åœ¨è½½å…¥æ•°æ®...</div>
                </div>
            </div>
        </div>

        <!-- æŠ¥å‘Šè¯¦æƒ… Modal æ•ˆæœ -->
        <div id="reportModal" class="card d-none">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“„ æŠ¥å‘Šè¯¦æƒ…: <span id="reportTitle"></span></span>
                <button class="btn-close" onclick="closeReport()"></button>
            </div>
            <div class="card-body">
                <div id="reportDetail" class="report-content"></div>
                <div class="text-end mt-3">
                    <button class="btn btn-secondary btn-sm" onclick="closeReport()">è¿”å›åˆ—è¡¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';

        // æäº¤åˆ†æ
        document.getElementById('analyzeBtn').onclick = async () => {
            const btn = document.getElementById('analyzeBtn');
            const status = document.getElementById('analyzeStatus');
            btn.disabled = true;
            status.innerHTML = '<div class="alert alert-info py-2">ä»»åŠ¡æ­£åœ¨æäº¤è‡³äº‘ç«¯ï¼Œè¯·ç¨å€™...</div>';
            
            try {
                // å¿…é¡»å‘é€ JSON Body ä»¥é¿å… 422 é”™è¯¯
                const response = await fetch(`${API_BASE}/analysis/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stock_codes: ["NVDA", "GOOGL", "AMZN"],
                        async_mode: true, // ä½¿ç”¨å¼‚æ­¥æ¨¡å¼é˜²æ­¢ç½‘å…³è¶…æ—¶
                        report_type: "detailed"
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    status.innerHTML = `<div class="alert alert-success py-2">âœ… ä»»åŠ¡å·²æ¥å—ï¼è¯·ç•™æ„æ‚¨çš„ Telegram é€šçŸ¥ã€‚</div>`;
                } else {
                    const errorMsg = data.detail?.message || data.message || 'æœªçŸ¥é”™è¯¯';
                    status.innerHTML = `<div class="alert alert-danger py-2">âŒ æäº¤å¤±è´¥: ${errorMsg}</div>`;
                }
            } catch (err) {
                status.innerHTML = `<div class="alert alert-danger py-2">âŒ ç½‘ç»œé”™è¯¯: ${err.message}</div>`;
            } finally {
                btn.disabled = false;
                setTimeout(loadHistory, 2000); // å»¶è¿Ÿåˆ·æ–°åˆ—è¡¨
            }
        };

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            const list = document.getElementById('historyList');
            try {
                const res = await fetch(`${API_BASE}/history?limit=10`);
                const data = await res.json();
                
                if (data.items && data.items.length > 0) {
                    list.innerHTML = data.items.map(item => `
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3" onclick="showReport('${item.query_id}', '${item.stock_code}')">
                            <div>
                                <strong class="text-dark">${item.stock_code}</strong> 
                                <span class="text-secondary ms-2">${item.stock_name || ''}</span>
                                <div class="time-tag mt-1">${new Date(item.created_at).toLocaleString()}</div>
                            </div>
                            <span class="badge bg-light text-primary border border-primary-subtle rounded-pill px-3">æŸ¥çœ‹æŠ¥å‘Š</span>
                        </button>
                    `).join('');
                } else {
                    list.innerHTML = '<div class="p-4 text-center text-muted">æš‚æ— åˆ†æå†å²ã€‚</div>';
                }
            } catch (err) {
                list.innerHTML = '<div class="p-4 text-center text-danger">æ•°æ®åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚</div>';
            }
        }

        // æ˜¾ç¤ºè¯¦æƒ…
        async function showReport(queryId, stockCode) {
            const modal = document.getElementById('reportModal');
            const detail = document.getElementById('reportDetail');
            const title = document.getElementById('reportTitle');
            
            modal.classList.remove('d-none');
            title.innerText = stockCode;
            detail.innerText = 'æ­£åœ¨ä»æ•°æ®åº“è°ƒå–æ·±åº¦åˆ†æç»“æœ...';
            modal.scrollIntoView({ behavior: 'smooth' });

            try {
                const res = await fetch(`${API_BASE}/history/${queryId}`);
                const data = await res.json();
                detail.innerText = data.content || 'æŠ¥å‘Šå†…å®¹ä¸ºç©ºã€‚';
            } catch (err) {
                detail.innerText = 'æ— æ³•è·å–æŠ¥å‘Šè¯¦æƒ…ã€‚';
            }
        }

        function closeReport() {
            document.getElementById('reportModal').classList.add('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆå§‹åŒ–
        loadHistory();
        // æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡åˆ—è¡¨
        setInterval(loadHistory, 30000);
    </script>
</body>
</html>
