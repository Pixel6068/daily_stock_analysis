<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥è‚¡ç¥¨åˆ†ææ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .container { max-width: 800px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #status { font-weight: bold; }
        .report-content { white-space: pre-wrap; background: #fff; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; max-height: 500px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-4">ğŸ“ˆ æ¯æ—¥è‚¡ç¥¨åˆ†ææ§åˆ¶å°</h2>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">è§¦å‘åˆ†æ</h5>
                <p class="card-text">æ‰‹åŠ¨è§¦å‘å¯¹ NVDA, GOOGL, AMZN çš„æœ€æ–°æ•°æ®åˆ†æã€‚</p>
                <button id="analyzeBtn" class="btn btn-primary">æ‰§è¡Œæ™ºèƒ½åˆ†æ</button>
                <div id="analyzeStatus" class="mt-3"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">å†å²æŠ¥å‘Š</h5>
                <div class="list-group" id="historyList">
                    <p class="text-muted">æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
                </div>
            </div>
        </div>

        <div id="reportModal" class="card d-none">
            <div class="card-body">
                <h5 class="card-title">åˆ†ææŠ¥å‘Šè¯¦æƒ…</h5>
                <div id="reportDetail" class="report-content mt-3"></div>
                <button class="btn btn-secondary mt-3" onclick="document.getElementById('reportModal').classList.add('d-none')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';

        // è§¦å‘åˆ†æ
        document.getElementById('analyzeBtn').onclick = async () => {
            const btn = document.getElementById('analyzeBtn');
            const status = document.getElementById('analyzeStatus');
            btn.disabled = true;
            status.innerHTML = '<div class="alert alert-info">åˆ†æä»»åŠ¡å·²æäº¤ï¼Œè¯·ç¨å€™...</div>';
            
            try {
                const res = await fetch(`${API_BASE}/analysis/analyze`, { method: 'POST' });
                const data = await res.json();
                if (data.task_id) {
                    status.innerHTML = `<div class="alert alert-success">ä»»åŠ¡æäº¤æˆåŠŸï¼Task ID: ${data.task_id}ã€‚è¯·æŸ¥çœ‹ Telegram æˆ–åˆ·æ–°å†å²è®°å½•ã€‚</div>`;
                } else {
                    status.innerHTML = '<div class="alert alert-danger">æäº¤å¤±è´¥ã€‚</div>';
                }
            } catch (err) {
                status.innerHTML = `<div class="alert alert-danger">é”™è¯¯: ${err.message}</div>`;
            }
            btn.disabled = false;
            loadHistory();
        };

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            const list = document.getElementById('historyList');
            try {
                const res = await fetch(`${API_BASE}/history`);
                const data = await res.json();
                if (data.items && data.items.length > 0) {
                    list.innerHTML = data.items.map(item => `
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="showReport('${item.query_id}')">
                            <span>${item.stock_code} - ${new Date(item.created_at).toLocaleString()}</span>
                            <span class="badge bg-primary rounded-pill">æŸ¥çœ‹</span>
                        </button>
                    `).join('');
                } else {
                    list.innerHTML = '<p class="text-muted">æš‚æ— å†å²è®°å½•ã€‚</p>';
                }
            } catch (err) {
                list.innerHTML = '<p class="text-danger">åŠ è½½å¤±è´¥</p>';
            }
        }

        // æ˜¾ç¤ºæŠ¥å‘Š
        async function showReport(queryId) {
            const modal = document.getElementById('reportModal');
            const detail = document.getElementById('reportDetail');
            modal.classList.remove('d-none');
            detail.innerText = 'åŠ è½½ä¸­...';
            
            try {
                const res = await fetch(`${API_BASE}/history/${queryId}`);
                const data = await res.json();
                detail.innerText = data.content || 'æ— å†…å®¹';
                modal.scrollIntoView();
            } catch (err) {
                detail.innerText = 'åŠ è½½è¯¦æƒ…å¤±è´¥';
            }
        }

        loadHistory();
    </script>
</body>
</html>
