<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Pro Analysis Console</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0f172a;
            --accent-color: #3b82f6;
            --bg-color: #f1f5f9;
        }
        body { background-color: var(--bg-color); padding-top: 40px; font-family: 'Inter', -apple-system, sans-serif; }
        .container { max-width: 1000px; }
        .glass-card { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(226, 232, 240, 0.8); border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); transition: transform 0.2s; margin-bottom: 24px; }
        .card-header { background: transparent; border-bottom: 1px solid #f1f5f9; padding: 20px 24px; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; justify-content: space-between; }
        .btn-primary { background-color: var(--accent-color); border: none; border-radius: 10px; padding: 12px 24px; font-weight: 600; }
        .btn-primary:hover { background-color: #2563eb; transform: translateY(-1px); }
        .stock-tag { background: #e2e8f0; color: #475569; padding: 6px 14px; border-radius: 8px; margin: 4px; font-size: 14px; font-weight: 500; cursor: default; }
        .stock-tag:hover { background: #cbd5e1; }
        .remove-btn { cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .remove-btn:hover { color: #ef4444; }
        .stat-card { background: white; border: 1px solid #f1f5f9; padding: 16px; border-radius: 12px; height: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .report-section-title { font-size: 16px; font-weight: 700; color: var(--primary-color); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #3b82f6; display: inline-block; }
        .battle-plan { background: #eff6ff; border-radius: 12px; padding: 20px; border-left: 4px solid var(--accent-color); }
        .risk-alert { background: #fef2f2; border-radius: 12px; padding: 20px; border-left: 4px solid #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h2 class="fw-bold text-slate-900 m-0"><i class="bi bi-graph-up-arrow me-2 text-primary"></i>Stock Intelligence Portal</h2>
            <div class="text-muted small">v2.0 Professional Edition</div>
        </div>

        <div class="glass-card p-4">
            <div class="row g-3">
                <div class="col-md-9">
                    <label class="form-label fw-semibold text-muted small">Watchlist Setup (Ticker codes separated by comma)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-search"></i></span>
                        <input type="text" id="newStockCode" class="form-control border-start-0 ps-0" placeholder="e.g., 00700.HK, AAPL, TSLA, D05.SI">
                        <button class="btn btn-primary" onclick="addCustomStock()">Add Tickers</button>
                    </div>
                    <div id="stockTags" class="mt-3 d-flex flex-wrap"></div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="analyzeBtn" class="btn btn-primary w-100 py-3 shadow-sm"><i class="bi bi-cpu me-2"></i>Run Deep Analysis</button>
                </div>
            </div>
            <div id="analyzeStatus" class="mt-3"></div>
        </div>

        <div class="glass-card">
            <div class="card-header">
                <span><i class="bi bi-clock-history me-2"></i>Recent Intelligence Reports</span>
                <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="loadHistory()"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="historyList">
                    <div class="p-5 text-center text-muted">Initialize system to fetch data...</div>
                </div>
            </div>
        </div>

        <div id="reportModal" class="glass-card d-none">
            <div class="card-header bg-dark text-white rounded-top-4">
                <span><i class="bi bi-file-earmark-bar-graph me-2"></i>Deep Analysis: <span id="reportTitle" class="badge bg-primary ms-2"></span></span>
                <button class="btn-close btn-close-white" onclick="closeReport()"></button>
            </div>
            <div class="card-body p-4">
                <div id="reportDetail"></div>
                <div class="mt-4 text-center">
                    <button class="btn btn-secondary px-5 rounded-pill" onclick="closeReport()">Return to Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let customStocks = ['00700.HK', 'AAPL', 'NVDA', 'D05.SI'];
        function renderStockTags() {
            document.getElementById('stockTags').innerHTML = customStocks.map(s => `
                <span class="stock-tag">
                    \${s} <i class="bi bi-x-circle-fill remove-btn ms-1" onclick="removeStock('\${s}')"></i>
                </span>`).join('');
        }
        function addCustomStock() {
            const input = document.getElementById('newStockCode');
            const codes = input.value.split(',').map(c => c.trim().toUpperCase()).filter(c => c && !customStocks.includes(c));
            customStocks.push(...codes);
            renderStockTags();
            input.value = '';
        }
        function removeStock(code) {
            customStocks = customStocks.filter(s => s !== code);
            renderStockTags();
        }
        document.getElementById('analyzeBtn').onclick = async () => {
            if (customStocks.length === 0) return alert('Please add tickers first');
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            for (const stock of customStocks) {
                try {
                    await fetch(\`\${API_BASE}/analysis/analyze\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ stock_codes: [stock], async_mode: true })
                    });
                } catch (e) {}
            }
            setTimeout(() => { 
                btn.disabled = false; 
                btn.innerHTML = '<i class="bi bi-cpu me-2"></i>Run Deep Analysis';
                loadHistory(); 
            }, 2000);
        };
        async function loadHistory() {
            const list = document.getElementById('historyList');
            try {
                const res = await fetch(\`\${API_BASE}/history?limit=20\`);
                const data = await res.json();
                if (data.items?.length > 0) {
                    list.innerHTML = data.items.map(item => \`
                        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 border-0 border-bottom" 
                                onclick="showReport('\${item.query_id}', '\${item.stock_code}')">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary text-white rounded-3 p-2 me-3"><i class="bi bi-graph-up"></i></div>
                                <div>
                                    <div class="fw-bold text-dark">\${item.stock_code} <span class="text-muted small fw-normal">\${item.stock_name || ''}</span></div>
                                    <div class="text-muted small" style="font-size: 11px"><i class="bi bi-calendar3 me-1"></i>\${new Date(item.created_at).toLocaleString()}</div>
                                </div>
                            </div>
                            <span class="btn btn-sm btn-light border rounded-pill">View Report</span>
                        </button>\`).join('');
                } else {
                    list.innerHTML = '<div class="p-5 text-center text-muted">No historical analysis found.</div>';
                }
            } catch (e) { list.innerHTML = '<div class="p-5 text-center text-danger">Data sync failed.</div>'; }
        }
        async function showReport(queryId, stockCode) {
            const modal = document.getElementById('reportModal');
            const detail = document.getElementById('reportDetail');
            modal.classList.remove('d-none');
            document.getElementById('reportTitle').innerText = stockCode;
            detail.innerHTML = '<div class="text-center py-5"><div class="spinner-grow text-primary"></div><p class="mt-2 text-muted">Retrieving depth intelligence...</p></div>';
            modal.scrollIntoView({ behavior: 'smooth' });
            try {
                const res = await fetch(\`\${API_BASE}/history/\${queryId}\`);
                const data = await res.json();
                const raw = data.details?.raw_result || {};
                const summary = data.summary || {};
                const score = summary.sentiment_score || 0;
                const color = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                
                detail.innerHTML = \`
                    <div class="row mb-4 align-items-center">
                        <div class="col-md-8">
                            <h3 class="fw-bold mb-0">\${data.meta?.stock_name || stockCode}</h3>
                            <p class="text-muted mb-0 small">Analysis conducted on \${new Date().toLocaleDateString()}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-inline-block text-center p-3 border rounded-4 bg-light shadow-sm">
                                <div class="fs-2 fw-800" style="color: \${color}">\${score}</div>
                                <div class="badge" style="background: \${color}">\${summary.sentiment_label || 'Neutral'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-3"><div class="stat-card">
                            <div class="text-muted small mb-1">Trend Prediction</div>
                            <div class="fw-bold text-primary">\${summary.trend_prediction || 'N/A'}</div>
                        </div></div>
                        <div class="col-md-3"><div class="stat-card">
                            <div class="text-muted small mb-1">Operation Advice</div>
                            <div class="fw-bold text-danger">\${summary.operation_advice || 'N/A'}</div>
                        </div></div>
                        <div class="col-md-3"><div class="stat-card">
                            <div class="text-muted small mb-1">Current Price</div>
                            <div class="fw-bold">\${data.meta?.current_price?.toFixed(2) || 'N/A'}</div>
                        </div></div>
                        <div class="col-md-3"><div class="stat-card">
                            <div class="text-muted small mb-1">24h Change</div>
                            <div class="fw-bold \${data.meta?.change_pct >=0 ? 'text-success':'text-danger'}">\${data.meta?.change_pct >=0 ? '+':''}\${data.meta?.change_pct}%</div>
                        </div></div>
                    </div>
                    <div class="mb-4">
                        <div class="report-section-title"><i class="bi bi-lightning-fill me-1"></i>Core Intelligence</div>
                        <p class="fs-5 fw-medium text-dark bg-light p-3 rounded-3 border-start border-4 border-primary">\${raw.dashboard?.core_conclusion?.one_sentence || 'N/A'}</p>
                    </div>
                    <div class="row">
                        <div class="col-md-7">
                            <div class="report-section-title"><i class="bi bi-eye-fill me-1"></i>Analytical Summary</div>
                            <p class="text-justify small" style="line-height:1.7">\${data.details?.analysis_summary || ''}</p>
                        </div>
                        <div class="col-md-5">
                            <div class="battle-plan mb-3">
                                <div class="fw-bold mb-2"><i class="bi bi-shield-shaded me-1"></i>Action Protocol</div>
                                <div class="small">
                                    <div class="mb-1">Positioning: <b>\${raw.dashboard?.battle_plan?.position_strategy?.suggested_position || 'N/A'}</b></div>
                                    <div class="mb-1 text-danger">Stop Loss: <b>\${raw.dashboard?.battle_plan?.sniper_points?.stop_loss || 'N/A'}</b></div>
                                    <div class="text-success">Profit Target: <b>\${raw.dashboard?.battle_plan?.sniper_points?.take_profit || 'N/A'}</b></div>
                                </div>
                            </div>
                            <div class="risk-alert small">
                                <div class="fw-bold mb-2"><i class="bi bi-exclamation-triangle-fill me-1"></i>Critical Risks</div>
                                \${(raw.intelligence?.risk_alerts || []).map(r => \`<div>â€¢ \${r}</div>\`).join('') || 'None identified'}
                            </div>
                        </div>
                    </div>
                \`;
            } catch (e) { detail.innerHTML = '<div class="alert alert-danger">Error fetching deep data.</div>'; }
        }
        function closeReport() { document.getElementById('reportModal').classList.add('d-none'); window.scrollTo({top:0, behavior:'smooth'}); }
        renderStockTags(); loadHistory();
        setInterval(loadHistory, 60000);
    </script>
</body>
</html>
