<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥è‚¡ç¥¨åˆ†ææ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 900px; }
        .card { border: none; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .card-header { background-color: #fff; border-bottom: 1px solid #f0f0f0; border-radius: 12px 12px 0 0 !important; font-weight: bold; }
        .btn-primary { background-color: #007bff; border: none; border-radius: 8px; padding: 10px 20px; }
        .btn-primary:hover { background-color: #0056b3; }
        .report-content { background: #fff; padding: 25px; border-radius: 8px; border: 1px solid #eee; font-size: 14px; line-height: 1.6; }
        .stock-tag { display: inline-block; padding: 2px 10px; background: #e7f3ff; color: #007bff; border-radius: 4px; font-size: 13px; margin-right: 8px; margin-bottom: 5px; cursor: pointer; }
        .time-tag { color: #999; font-size: 12px; }
        .sentiment-badge { font-size: 14px; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        .sentiment-score { font-size: 24px; font-weight: 800; color: #333; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat-label { font-size: 12px; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 16px; font-weight: bold; }
        .conclusion-box { background: #fff8f8; border-left: 4px solid #dc3545; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .battle-plan { background: #f0f7ff; border-left: 4px solid #007bff; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .stock-status { font-size: 12px; padding: 2px 8px; border-radius: 4px; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-success { background: #d1e7dd; color: #0f5132; }
        .status-error { background: #f8d7da; color: #842029; }
        .remove-btn { color: #ccc; margin-left: 5px; }
        .remove-btn:hover { color: #ff4d4f; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-5">ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†ææ§åˆ¶å°</h2>
        
        <div class="card">
            <div class="card-header">ğŸš€ è§¦å‘åˆ†æ</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small text-muted">è‡ªé€‰è‚¡ç¥¨ä»£ç  (è¾“å…¥åæŒ‰å›è½¦æ·»åŠ )ï¼š</label>
                    <div class="input-group mb-2">
                        <input type="text" id="newStockCode" class="form-control" placeholder="ä¾‹å¦‚: AAPL, TSLA, 00700.HK">
                        <button class="btn btn-outline-secondary" onclick="addCustomStock()">æ·»åŠ </button>
                    </div>
                    <div id="stockTags" class="d-flex flex-wrap">
                        <!-- åŠ¨æ€ç”Ÿæˆè‚¡ç¥¨æ ‡ç­¾ -->
                    </div>
                </div>
                <button id="analyzeBtn" class="btn btn-primary w-100">ç«‹å³å¼€å§‹æ™ºèƒ½åˆ†æ</button>
                <div id="analyzeStatus" class="mt-3"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“‚ å†å²åˆ†ææŠ¥å‘Š</div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="historyList">
                    <div class="p-4 text-center text-muted">æ­£åœ¨è½½å…¥æ•°æ®...</div>
                </div>
            </div>
        </div>

        <!-- æŠ¥å‘Šè¯¦æƒ… Modal æ•ˆæœ -->
        <div id="reportModal" class="card d-none">
            <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
                <span>ğŸ“„ æŠ¥å‘Šè¯¦æƒ…: <span id="reportTitle"></span></span>
                <button class="btn-close btn-close-white" onclick="closeReport()"></button>
            </div>
            <div class="card-body">
                <div id="reportDetail" class="report-content">
                    <!-- åŠ¨æ€ç”ŸæˆæŠ¥å‘Šå†…å®¹ -->
                </div>
                <div class="text-end mt-3">
                    <button class="btn btn-secondary btn-sm px-4" onclick="closeReport()">è¿”å›åˆ—è¡¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let customStocks = ['NVDA', 'GOOGL', 'AMZN'];

        function renderStockTags() {
            const container = document.getElementById('stockTags');
            container.innerHTML = customStocks.map(s => \`
                <span class=\"stock-tag\">
                    \${s}
                    <span class=\"remove-btn\" onclick=\"removeStock('\${s}')\">&times;</span>
                </span>
            \`).join('');
        }

        function addCustomStock() {
            const input = document.getElementById('newStockCode');
            const code = input.value.trim().toUpperCase();
            if (code && !customStocks.includes(code)) {
                customStocks.push(code);
                renderStockTags();
                input.value = '';
            }
        }

        function removeStock(code) {
            customStocks = customStocks.filter(s => s !== code);
            renderStockTags();
        }

        document.getElementById('newStockCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addCustomStock();
        });

        // æäº¤åˆ†æ
        document.getElementById('analyzeBtn').onclick = async () => {
            if (customStocks.length === 0) return alert('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€åªè‚¡ç¥¨');
            
            const btn = document.getElementById('analyzeBtn');
            const status = document.getElementById('analyzeStatus');
            btn.disabled = true;

            let statusHTML = '<div class=\"mt-2\">';
            customStocks.forEach(s => {
                statusHTML += \`
                    <div class=\"d-flex align-items-center mb-1\" id=\"status-\${s.replace('.', '-')}\">
                        <span class=\"me-2\">\${s}</span>
                        <span class=\"stock-status status-pending\">ç­‰å¾…æäº¤...</span>
                    </div>\`;
            });
            statusHTML += '</div>';
            status.innerHTML = statusHTML;

            for (const stock of customStocks) {
                const rowId = \`status-\${stock.replace('.', '-')}\`;
                const rowEl = document.getElementById(rowId);
                const tagEl = rowEl.querySelector('.stock-status');
                tagEl.className = 'stock-status status-pending';
                tagEl.textContent = 'æäº¤ä¸­...';

                try {
                    const response = await fetch(\`\${API_BASE}/analysis/analyze\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            stock_codes: [stock],
                            async_mode: true,
                            report_type: 'detailed'
                        })
                    });
                    
                    if (response.ok || response.status === 202 || response.status === 409) {
                        tagEl.className = 'stock-status status-success';
                        tagEl.textContent = response.status === 409 ? 'åˆ†æä¸­ï¼ˆå·²åœ¨é˜Ÿåˆ—ï¼‰' : 'âœ… å·²åŠ å…¥é˜Ÿåˆ—';
                    } else {
                        tagEl.className = 'stock-status status-error';
                        tagEl.textContent = 'âŒ æäº¤å¤±è´¥';
                    }
                } catch (err) {
                    tagEl.className = 'stock-status status-error';
                    tagEl.textContent = 'âŒ ç½‘ç»œé”™è¯¯';
                }
            }
            btn.disabled = false;
            setTimeout(loadHistory, 3000);
        };

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            const list = document.getElementById('historyList');
            try {
                const res = await fetch(\`\${API_BASE}/history?limit=20\`);
                const data = await res.json();
                if (data.items && data.items.length > 0) {
                    list.innerHTML = data.items.map(item => \`
                        <button class=\"list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3\" 
                                onclick=\"showReport('\${item.query_id}', '\${item.stock_code}')\">
                            <div>
                                <strong class=\"text-dark\">\${item.stock_code}</strong>
                                <span class=\"text-secondary ms-2 small\">\${item.stock_name || ''}</span>
                                <div class=\"time-tag mt-1\">\${new Date(item.created_at).toLocaleString()}</div>
                            </div>
                            <span class=\"badge bg-light text-primary border border-primary-subtle rounded-pill px-3\">æŸ¥çœ‹æŠ¥å‘Š</span>
                        </button>
                    \`).join('');
                } else {
                    list.innerHTML = '<div class=\"p-4 text-center text-muted\">æš‚æ— åˆ†æå†å²ã€‚</div>';
                }
            } catch (err) {
                list.innerHTML = '<div class=\"p-4 text-center text-danger\">æ•°æ®åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚</div>';
            }
        }

        // æ˜¾ç¤ºè¯¦æƒ…
        async function showReport(queryId, stockCode) {
            const modal = document.getElementById('reportModal');
            const detail = document.getElementById('reportDetail');
            const title = document.getElementById('reportTitle');
            
            modal.classList.remove('d-none');
            title.innerText = \`\${stockCode}\`;
            detail.innerHTML = '<div class=\"text-center p-5 text-muted\">æ­£åœ¨è°ƒå–æ·±åº¦åˆ†æç»“æœ...</div>';
            modal.scrollIntoView({ behavior: 'smooth' });

            try {
                const res = await fetch(\`\${API_BASE}/history/\${queryId}\`);
                const data = await res.json();
                
                const raw = data.details?.raw_result || {};
                const dashboard = raw.dashboard || {};
                const core = dashboard.core_conclusion || {};
                const battle = dashboard.battle_plan || {};
                const sentiment = data.summary || {};

                // æ ¹æ®åˆ†å€¼å†³å®šé¢œè‰²
                const getScoreColor = (score) => {
                    if (score >= 70) return '#198754'; 
                    if (score >= 50) return '#ffc107'; 
                    return '#dc3545'; 
                };

                detail.innerHTML = \`
                    <div class=\"d-flex justify-content-between align-items-start mb-4\">
                        <div>
                            <h3 class=\"mb-1\">\${data.meta?.stock_name || stockCode}</h3>
                            <div class=\"text-muted small\">\${new Date(data.meta?.created_at).toLocaleString()}</div>
                        </div>
                        <div class=\"text-end\">
                            <div class=\"sentiment-score\" style=\"color: \${getScoreColor(sentiment.sentiment_score)}\">\${sentiment.sentiment_score || 'N/A'}</div>
                            <div class=\"sentiment-badge badge\" style=\"background: \${getScoreColor(sentiment.sentiment_score)}\">\${sentiment.sentiment_label || 'æœªçŸ¥'}</div>
                        </div>
                    </div>

                    <div class=\"dashboard-grid\">
                        <div class=\"stat-box\">
                            <div class=\"stat-label\">è¶‹åŠ¿é¢„æµ‹</div>
                            <div class=\"stat-value text-primary\">\${sentiment.trend_prediction || 'N/A'}</div>
                        </div>
                        <div class=\"stat-box\">
                            <div class=\"stat-label\">æ“ä½œå»ºè®®</div>
                            <div class=\"stat-value text-danger\">\${sentiment.operation_advice || 'N/A'}</div>
                        </div>
                        <div class=\"stat-box\">
                            <div class=\"stat-label\">å½“å‰ä»·æ ¼</div>
                            <div class=\"stat-value font-monospace\">\${data.meta?.current_price?.toFixed(2) || 'N/A'}</div>
                        </div>
                        <div class=\"stat-box\">
                            <div class=\"stat-label\">å½“æ—¥æ¶¨è·Œ</div>
                            <div class=\"stat-value \${data.meta?.change_pct >= 0 ? 'text-success' : 'text-danger'}\">
                                \${data.meta?.change_pct >= 0 ? '+' : ''}\${data.meta?.change_pct || 0}%
                            </div>
                        </div>
                    </div>

                    <div class=\"conclusion-box\">
                        <h6 class=\"fw-bold mb-2\">æ ¸å¿ƒç»“è®º</h6>
                        <div class=\"fs-5\">\${core.one_sentence || 'æš‚æ— æ ¸å¿ƒç»“è®ºã€‚'}</div>
                        <div class=\"mt-2 small\">
                            <span class=\"badge bg-secondary me-2\">\${core.signal_type || 'å¸¸è§„'}</span>
                            <span class=\"text-muted\">æ—¶æ•ˆï¼š\${core.time_sensitivity || 'ä»Šæ—¥'}</span>
                        </div>
                    </div>

                    <div class=\"row\">
                        <div class=\"col-md-7\">
                            <h6 class=\"fw-bold mb-3 border-bottom pb-2\">åˆ†ææ‘˜è¦</h6>
                            <p style=\"text-align: justify\">\${data.details?.analysis_summary || 'æš‚æ— è¯¦ç»†æ‘˜è¦ã€‚'}</p>
                            
                            <h6 class=\"fw-bold mt-4 mb-3 border-bottom pb-2\">æŠ€æœ¯é¢é€è§†</h6>
                            <ul class=\"list-unstyled small\">
                                <li class=\"mb-2\"><strong>å‡çº¿çŠ¶æ€ï¼š</strong> \${raw.data_perspective?.trend_status?.ma_alignment || 'N/A'}</li>
                                <li class=\"mb-2\"><strong>æ”¯æ’‘ä½ï¼š</strong> \${raw.data_perspective?.price_position?.support_level || 'N/A'}</li>
                                <li class=\"mb-2\"><strong>é˜»åŠ›ä½ï¼š</strong> \${raw.data_perspective?.price_position?.resistance_level || 'N/A'}</li>
                                <li class=\"mb-2\"><strong>é‡èƒ½ï¼š</strong> \${raw.data_perspective?.volume_analysis?.volume_meaning || 'N/A'}</li>
                            </ul>
                        </div>
                        <div class=\"col-md-5\">
                            <div class=\"battle-plan\">
                                <h6 class=\"fw-bold mb-3 text-primary\">ä½œæˆ˜å»ºè®®</h6>
                                <div class=\"small\">
                                    <div class=\"mb-2\"><strong>å»ºè®®ä»“ä½ï¼š</strong> \${battle.position_strategy?.suggested_position || 'N/A'}</div>
                                    <div class=\"mb-2\"><strong>æ­¢æŸå‚è€ƒï¼š</strong> \${battle.sniper_points?.stop_loss || 'N/A'}</div>
                                    <div class=\"mb-2\"><strong>æ­¢ç›ˆå‚è€ƒï¼š</strong> \${battle.sniper_points?.take_profit || 'N/A'}</div>
                                </div>
                            </div>
                            
                            <h6 class=\"fw-bold mb-3 border-bottom pb-2\">é£é™©è­¦ç¤º</h6>
                            <div class=\"small\">
                                \${(raw.intelligence?.risk_alerts || []).map(r => \`<div class=\"mb-1 text-danger\">âš ï¸ \${r}</div>\`).join('') || 'æš‚æ— é£é™©ä¿¡æ¯'}
                            </div>
                        </div>
                    </div>
                \`;
            } catch (err) {
                console.error(err);
                detail.innerHTML = '<div class=\"alert alert-danger\">è·å–è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>';
            }
        }

        function closeReport() {
            document.getElementById('reportModal').classList.add('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åˆå§‹åŒ–
        renderStockTags();
        loadHistory();
        setInterval(loadHistory, 30000);
    </script>
</body>
</html>
